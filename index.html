<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warehouse Smart Dashboard | Dispatch Focus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .dark .glass-card { background: rgba(15, 23, 42, 0.8); }
        .sidebar-btn-active { background: #3b82f6; color: white !important; }
        .btn-primary { background-color: #3b82f6; color: white; transition: all 0.2s; }
        @media (min-width: 768px) { .main-content { margin-left: 280px; } }
        
        .scan-focus-ring { 
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .scan-focus-ring:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .live-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        @media print {
            .no-print { display: none !important; }
            #invoice-print-area, #invoice-print-area *,
            #delay-report-print-area, #delay-report-print-area * { visibility: visible; }
            body * { visibility: hidden; }
            #invoice-print-area { position: absolute; left: 0; top: 0; width: 100%; border: none !important; }
            #delay-report-print-area { position: absolute; left: 0; top: 0; width: 100%; border: none !important; }
        }

        .round-am { background-color: #fef3c7; color: #92400e; }
        .round-pm { background-color: #e0f2fe; color: #075985; }
        .dark .round-am { background-color: #92400e; color: #fef3c7; }
        .dark .round-pm { background-color: #075985; color: #e0f2fe; }

        .round-btn-active { 
            background-color: #3b82f6 !important; 
            color: white !important; 
            border-color: #3b82f6 !important;
        }

        .chart-wrapper { position: relative; width: 100%; height: 250px; }
        
        /* Glow effects for dashboard cards */
        .glow-green {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3), 
                        0 0 40px rgba(34, 197, 94, 0.2),
                        inset 0 0 20px rgba(34, 197, 94, 0.1);
        }
        
        .glow-yellow {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.3), 
                        0 0 40px rgba(250, 204, 21, 0.2),
                        inset 0 0 20px rgba(250, 204, 21, 0.1);
        }
        
        .glow-rose {
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.3), 
                        0 0 40px rgba(244, 63, 94, 0.2),
                        inset 0 0 20px rgba(244, 63, 94, 0.1);
        }
        
        .glow-white {
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.6), 
                        0 0 50px rgba(255, 255, 255, 0.4),
                        inset 0 0 25px rgba(255, 255, 255, 0.3);
        }
        
        .dark .glow-green {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4), 
                        0 0 40px rgba(34, 197, 94, 0.3),
                        inset 0 0 20px rgba(34, 197, 94, 0.2);
        }
        
        .dark .glow-yellow {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.4), 
                        0 0 40px rgba(250, 204, 21, 0.3),
                        inset 0 0 20px rgba(250, 204, 21, 0.2);
        }
        
        .dark .glow-rose {
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.4), 
                        0 0 40px rgba(244, 63, 94, 0.3),
                        inset 0 0 20px rgba(244, 63, 94, 0.2);
        }
        
        .dark .glow-white {
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 
                        0 0 60px rgba(255, 255, 255, 0.6),
                        inset 0 0 30px rgba(255, 255, 255, 0.4);
        }
        
        /* Additional contrast for light mode */
        .bg-gradient-to-br.from-slate-800.to-slate-900 {
            background: linear-gradient(135deg, rgb(30 41 59) 0%, rgb(15 23 42) 100%);
        }
    </style>
    <script>
        // --- Report Modal Logic ---
        function openReportTypeModal() {
            document.getElementById('report-type-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function showMonthPickerForMonthlyDispatch() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '9998';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            
            // Create date container
            const container = document.createElement('div');
            container.style.backgroundColor = '#1e293b';
            container.style.borderRadius = '16px';
            container.style.padding = '32px';
            container.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
            container.style.border = '2px solid #3b82f6';
            container.style.minWidth = '320px';
            
            // Create title
            const title = document.createElement('h3');
            title.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
            title.style.color = '#fff';
            title.style.fontSize = '20px';
            title.style.fontWeight = 'bold';
            title.style.marginBottom = '24px';
            title.style.textAlign = 'center';
            title.style.textTransform = 'uppercase';
            title.style.letterSpacing = '0.08em';
            title.style.lineHeight = '1.4';
            title.style.fontFamily = 'system-ui, -apple-system, sans-serif';
            title.style.display = 'flex';
            title.style.alignItems = 'center';
            title.style.justifyContent = 'center';
            title.style.width = '100%';
            
            // Create month input
            const monthInput = document.createElement('input');
            monthInput.type = 'month';
            monthInput.value = new Date().toISOString().slice(0, 7); // Format: YYYY-MM
            monthInput.style.width = '100%';
            monthInput.style.padding = '16px';
            monthInput.style.fontSize = '16px';
            monthInput.style.borderRadius = '12px';
            monthInput.style.border = '2px solid #475569';
            monthInput.style.backgroundColor = '#0f172a';
            monthInput.style.color = '#fff';
            monthInput.style.cursor = 'pointer';
            monthInput.style.outline = 'none';
            monthInput.style.transition = 'border-color 0.2s';
            monthInput.style.marginBottom = '20px';
            
            // Create buttons container
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '12px';
            buttonsContainer.style.justifyContent = 'center';
            
            // Create confirm button
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            confirmBtn.style.backgroundColor = '#3b82f6';
            confirmBtn.style.color = '#fff';
            confirmBtn.style.border = 'none';
            confirmBtn.style.padding = '12px 24px';
            confirmBtn.style.borderRadius = '8px';
            confirmBtn.style.fontSize = '14px';
            confirmBtn.style.fontWeight = 'bold';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.textTransform = 'uppercase';
            confirmBtn.style.letterSpacing = '0.05em';
            confirmBtn.style.transition = 'background-color 0.2s';
            
            // Create cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
            cancelBtn.style.backgroundColor = '#64748b';
            cancelBtn.style.color = '#fff';
            cancelBtn.style.border = 'none';
            cancelBtn.style.padding = '12px 24px';
            cancelBtn.style.borderRadius = '8px';
            cancelBtn.style.fontSize = '14px';
            cancelBtn.style.fontWeight = 'bold';
            cancelBtn.style.cursor = 'pointer';
            cancelBtn.style.textTransform = 'uppercase';
            cancelBtn.style.letterSpacing = '0.05em';
            cancelBtn.style.transition = 'background-color 0.2s';
            
            // Add hover effects
            confirmBtn.onmouseover = () => confirmBtn.style.backgroundColor = '#2563eb';
            confirmBtn.onmouseout = () => confirmBtn.style.backgroundColor = '#3b82f6';
            cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = '#475569';
            cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = '#64748b';
            
            // Add focus effect
            monthInput.onfocus = () => monthInput.style.borderColor = '#3b82f6';
            monthInput.onblur = () => monthInput.style.borderColor = '#475569';
            
            // Event handlers
            confirmBtn.onclick = function() {
                const selectedMonth = monthInput.value;
                document.body.removeChild(modal);
                openDispatchReportModal('month', null, selectedMonth);
            };
            
            cancelBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            
            // Close on escape
            const handleEscape = function(e) {
                if (e.key === 'Escape') {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // Assemble modal
            buttonsContainer.appendChild(confirmBtn);
            buttonsContainer.appendChild(cancelBtn);
            container.appendChild(title);
            container.appendChild(monthInput);
            container.appendChild(buttonsContainer);
            modal.appendChild(container);
            document.body.appendChild(modal);
            
            // Focus on input
            monthInput.focus();
        }

        function showDatePickerForDailyDispatch() {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '9998';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            
            // Create date container
            const container = document.createElement('div');
            container.style.backgroundColor = '#1e293b';
            container.style.borderRadius = '16px';
            container.style.padding = '32px';
            container.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
            container.style.border = '2px solid #3b82f6';
            container.style.minWidth = '320px';
            
            // Create title
            const title = document.createElement('h3');
            title.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
            title.style.color = '#fff';
            title.style.fontSize = '20px';
            title.style.fontWeight = 'bold';
            title.style.marginBottom = '24px';
            title.style.textAlign = 'center';
            title.style.textTransform = 'uppercase';
            title.style.letterSpacing = '0.08em';
            title.style.lineHeight = '1.4';
            title.style.fontFamily = 'system-ui, -apple-system, sans-serif';
            title.style.display = 'flex';
            title.style.alignItems = 'center';
            title.style.justifyContent = 'center';
            title.style.width = '100%';
            
            // Create date input
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = new Date().toISOString().split('T')[0];
            dateInput.style.width = '100%';
            dateInput.style.padding = '16px';
            dateInput.style.fontSize = '16px';
            dateInput.style.borderRadius = '12px';
            dateInput.style.border = '2px solid #475569';
            dateInput.style.backgroundColor = '#0f172a';
            dateInput.style.color = '#fff';
            dateInput.style.cursor = 'pointer';
            dateInput.style.outline = 'none';
            dateInput.style.transition = 'border-color 0.2s';
            dateInput.style.marginBottom = '20px';
            
            // Create buttons container
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '12px';
            buttonsContainer.style.justifyContent = 'center';
            
            // Create confirm button
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            confirmBtn.style.backgroundColor = '#3b82f6';
            confirmBtn.style.color = '#fff';
            confirmBtn.style.border = 'none';
            confirmBtn.style.padding = '12px 24px';
            confirmBtn.style.borderRadius = '8px';
            confirmBtn.style.fontSize = '14px';
            confirmBtn.style.fontWeight = 'bold';
            confirmBtn.style.cursor = 'pointer';
            confirmBtn.style.textTransform = 'uppercase';
            confirmBtn.style.letterSpacing = '0.05em';
            confirmBtn.style.transition = 'background-color 0.2s';
            
            // Create cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
            cancelBtn.style.backgroundColor = '#64748b';
            cancelBtn.style.color = '#fff';
            cancelBtn.style.border = 'none';
            cancelBtn.style.padding = '12px 24px';
            cancelBtn.style.borderRadius = '8px';
            cancelBtn.style.fontSize = '14px';
            cancelBtn.style.fontWeight = 'bold';
            cancelBtn.style.cursor = 'pointer';
            cancelBtn.style.textTransform = 'uppercase';
            cancelBtn.style.letterSpacing = '0.05em';
            cancelBtn.style.transition = 'background-color 0.2s';
            
            // Add hover effects
            confirmBtn.onmouseover = () => confirmBtn.style.backgroundColor = '#2563eb';
            confirmBtn.onmouseout = () => confirmBtn.style.backgroundColor = '#3b82f6';
            cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = '#475569';
            cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = '#64748b';
            
            // Add focus effect
            dateInput.onfocus = () => dateInput.style.borderColor = '#3b82f6';
            dateInput.onblur = () => dateInput.style.borderColor = '#475569';
            
            // Event handlers
            confirmBtn.onclick = function() {
                const selectedDate = dateInput.value;
                document.body.removeChild(modal);
                openDispatchReportModal('day', null, selectedDate);
            };
            
            cancelBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            
            // Close on escape
            const handleEscape = function(e) {
                if (e.key === 'Escape') {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // Assemble modal
            buttonsContainer.appendChild(confirmBtn);
            buttonsContainer.appendChild(cancelBtn);
            container.appendChild(title);
            container.appendChild(dateInput);
            container.appendChild(buttonsContainer);
            modal.appendChild(container);
            document.body.appendChild(modal);
            
            // Focus on input
            dateInput.focus();
        }

        function openDispatchReportModal(type) {
            closeModal('report-type-modal');
            
            // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (dispatch) ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            db.history.toArray().then(logs => {
                let summary = {};
                let label = '';
                let desc = '';
                
                if (type === 'month') {
                    // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const now = new Date();
                    const monthIdx = now.getMonth();
                    const thisYear = now.getFullYear();
                    const monthNamesTH = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                    
                    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const currentMonthLogs = logs.filter(log => {
                        const logDate = new Date(log.timestamp);
                        return logDate.getMonth() === monthIdx && logDate.getFullYear() === thisYear;
                    });
                    
                    let totalItems = 0;
                    let allItems = [];
                    
                    currentMonthLogs.forEach(log => {
                        const items = JSON.parse(log.itemsJson);
                        totalItems += items.length;
                        allItems.push(...items);
                    });
                    
                    summary[monthNamesTH[monthIdx] + ' ' + (thisYear + 543)] = {
                        total: totalItems,
                        items: allItems
                    };
                    label = '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)';
                    desc = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (' + monthNamesTH[monthIdx] + ' ' + (thisYear + 543) + ')';
                    
                } else {
                    // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    let dateStr = arguments[2];
                    if (!dateStr) dateStr = new Date().toISOString().split('T')[0];
                    
                    const dayLogs = logs.filter(log => log.timestamp.startsWith(dateStr));
                    let totalItems = 0;
                    let allItems = [];
                    
                    dayLogs.forEach(log => {
                        const items = JSON.parse(log.itemsJson);
                        totalItems += items.length;
                        allItems.push(...items);
                    });
                    
                    summary[dateStr] = {
                        total: totalItems,
                        items: allItems
                    };
                    label = '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)';
                    desc = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á (' + dateStr.split('-').reverse().join('/') + ')';
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á modal
                renderDispatchReportModal(summary, label, desc);
            });
        }

        function renderDispatchReportModal(summary, label, desc) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô modal
            document.getElementById('dispatch-report-title').innerText = label;
            document.getElementById('dispatch-report-desc').innerText = desc;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            let rows = [];
            Object.keys(summary).forEach(day => {
                let showDay = day;
                const d = day.split('-');
                if (d.length === 3) {
                    showDay = d[2] + '/' + d[1] + '/' + d[0];
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å
                if (summary[day].items && Array.isArray(summary[day].items)) {
                    summary[day].items.forEach((item, index) => {
                        rows.push(`
                            <tr class="hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                                <td class="py-3 px-4 text-left font-bold">${index === 0 ? showDay : ''}</td>
                                <td class="py-3 px-4">
                                    <div class="font-bold text-[11px] uppercase">${item.kanbanId || '-'}</div>
                                    <div class="text-[8px] font-black text-primary uppercase">PART: ${item.salePart}</div>
                                    <div class="text-[8px] font-black text-slate-400 uppercase">ORDER: ${item.orderNo || '-'}</div>
                                </td>
                                <td class="py-3 px-4 text-center font-black text-blue-500 text-[11px]">${showDay}</td>
                                <td class="py-3 px-4 text-right font-black text-lg text-blue-600">${item.qty.toLocaleString()}</td>
                            </tr>
                        `);
                    });
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏™‡∏£‡∏∏‡∏õ
                    rows.push(`
                        <tr class="hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                            <td class="py-3 px-4 text-left font-bold">${showDay}</td>
                            <td class="py-3 px-4 text-left">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                            <td class="py-3 px-4 text-center font-black text-blue-500 text-[11px]">${showDay}</td>
                            <td class="py-3 px-4 text-right font-black text-lg text-blue-600">${summary[day]}</td>
                        </tr>
                    `);
                }
            });
            
            document.getElementById('dispatch-report-table').innerHTML = rows.join('');
            
            // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
            const days = Object.keys(summary).length;
            const totalUnits = Object.values(summary).reduce((a, b) => a + (b.items ? b.items.reduce((sum, item) => sum + item.qty, 0) : b), 0);
            
            // ‡πÅ‡∏™‡∏î‡∏á Days ‡∏´‡∏£‡∏∑‡∏≠ Month ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            const isMonthly = label.includes('‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
            document.getElementById('dispatch-total-days').innerText = days;
            document.getElementById('dispatch-total-days-label').innerText = isMonthly ? 'Month' : 'Days';
            document.getElementById('dispatch-total-units').innerText = totalUnits.toLocaleString();
            document.getElementById('dispatch-report-date').innerText = new Date().toLocaleDateString('th-TH', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            document.getElementById('dispatch-report-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function openDelayReportModal(type = 'month') {
            // Delay Report Modal with real data
            const modal = document.getElementById('delay-report-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'items-center', 'justify-center');
            
            // Update report date
            document.getElementById('report-date').innerText = new Date().toLocaleDateString('th-TH', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Get delay data from orders
            db.orders.toArray().then(all => {
                console.log('All orders in database:', all); // Debug log
                console.log('Total orders count:', all.length); // Debug log
                
                const todayStr = new Date().toISOString().split('T')[0];
                const today = new Date(todayStr);
                console.log('Today date:', todayStr); // Debug log
                
                // Check each order's delivery date
                all.forEach(order => {
                    const deliveryDate = new Date(order.deliveryDate);
                    const isDelay = order.qty > 0 && deliveryDate < today;
                    console.log(`Order: ${order.kanbanId}, Delivery: ${order.deliveryDate}, Delivery Date Obj: ${deliveryDate.toISOString()}, Qty: ${order.qty}, Is Delay: ${isDelay}`);
                });
                
                const delayItems = all.filter(o => {
                    const deliveryDate = new Date(o.deliveryDate);
                    return o.qty > 0 && deliveryDate < today;
                });
                console.log('Delay items found:', delayItems); // Debug log
                console.log('Delay items count:', delayItems.length); // Debug log
                
                // Create table rows
                let rows = '';
                if (delayItems.length > 0) {
                    delayItems.forEach((item, index) => {
                        rows += `
                            <tr class="hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors">
                                <td class="py-3 px-4 text-left font-black text-[11px] uppercase">${item.customer || '-'}</td>
                                <td class="py-3 px-4">
                                    <div class="font-bold text-[11px] uppercase">${item.kanbanId || '-'}</div>
                                    <div class="text-[8px] font-black text-primary uppercase">PART: ${item.salePart || '-'}</div>
                                    <div class="text-[8px] font-black text-slate-400 uppercase">ORDER: ${item.orderNo || '-'}</div>
                                </td>
                                <td class="py-3 px-4 text-center font-black text-rose-500 text-[11px]">${item.deliveryDate || '-'}</td>
                                <td class="py-3 px-4 text-right font-black text-lg text-rose-600">${item.qty.toLocaleString()}</td>
                            </tr>
                        `;
                    });
                } else {
                    if (all.length === 0) {
                        rows = `
                            <tr class="hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors">
                                <td class="py-5 px-4 text-left text-[11px] font-black uppercase italic" colspan="4">üìã ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Order ‡∏Å‡πà‡∏≠‡∏ô</td>
                            </tr>
                        `;
                    } else {
                        rows = `
                            <tr class="hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors">
                                <td class="py-5 px-4 text-left text-[11px] font-black uppercase italic" colspan="4">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á ‡∏ó‡∏∏‡∏Å Order ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</td>
                            </tr>
                        `;
                    }
                }
                
                // Update table
                const tableBody = document.getElementById('report-table-body');
                if (tableBody) {
                    tableBody.innerHTML = rows;
                }
                
                // Update summary
                const totalItems = document.getElementById('report-total-items');
                const totalUnits = document.getElementById('report-total-units');
                if (totalItems) totalItems.innerText = delayItems.length;
                if (totalUnits) totalUnits.innerText = delayItems.reduce((sum, item) => sum + item.qty, 0).toLocaleString();
                
                lucide.createIcons();
            });
        }

        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: '#3b82f6', accent: '#10b981' } } } }
    </script>
    <style>
        /* Custom CSS for date picker icons in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(0.8);
        }
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        input[type="month"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(0.8);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(1) brightness(1.2);
        }
        .dark input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5);
        }
        .dark input[type="month"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(1) brightness(1.2);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen transition-colors duration-300">

    <!-- Mobile Top Bar -->
    <header class="md:hidden sticky top-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-primary p-1.5 rounded-lg text-white"><i data-lucide="warehouse" class="w-4 h-4"></i></div>
            <h1 class="font-black text-sm tracking-tighter uppercase">TGT3 <span class="text-primary">WMS</span></h1>
        </div>
        <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 active:scale-90 transition-all">
            <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
            <i data-lucide="moon" class="w-5 h-5 block dark:hidden text-slate-500"></i>
        </button>
    </header>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[200] hidden bg-slate-950/80 backdrop-blur-md flex flex-col items-center justify-center text-white">
        <div class="w-10 h-10 border-4 border-white/20 border-t-white rounded-full animate-spin mb-4"></div>
        <p id="loading-progress" class="text-sm font-bold tracking-widest uppercase">Processing...</p>
    </div>

    <!-- Duplicate Alert Modal -->
    <div id="duplicate-alert-modal" class="fixed inset-0 z-[300] hidden bg-slate-950/60 backdrop-blur-[2px] flex items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-[320px] rounded-[2rem] p-6 shadow-2xl text-center animate-in zoom-in-95 duration-200 border border-amber-500/20">
            <div class="w-12 h-12 bg-amber-100 dark:bg-amber-500/20 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="copy" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-black mb-1">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</h3>
            <p id="duplicate-count-text" class="text-slate-500 dark:text-slate-400 text-[11px] mb-6 font-medium leading-relaxed px-2"></p>
            <div class="flex flex-col gap-2">
                <button onclick="closeModal('duplicate-alert-modal')" class="w-full bg-amber-500 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-amber-600 active:scale-95 transition-all">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- Refund Confirm Modal -->
    <div id="refund-confirm-modal" class="fixed inset-0 z-[300] hidden bg-slate-950/60 backdrop-blur-[2px] flex items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-[320px] rounded-[2rem] p-6 shadow-2xl text-center animate-in zoom-in-95 duration-200 border border-orange-500/20">
            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-500/20 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="undo-2" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-black mb-1 italic">Refund Order?</h3>
            <p class="text-slate-500 dark:text-slate-400 text-[11px] mb-6 font-medium leading-relaxed px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å</p>
            <div class="flex flex-col gap-2">
                <button id="confirm-refund-btn" class="w-full bg-orange-500 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-orange-600 active:scale-95 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button onclick="closeModal('refund-confirm-modal')" class="w-full py-2 text-slate-400 font-bold text-[10px] uppercase tracking-widest text-center">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[300] hidden bg-slate-950/60 backdrop-blur-[2px] flex items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-[320px] rounded-[2rem] p-6 shadow-2xl text-center animate-in zoom-in-95 duration-200">
            <div class="w-12 h-12 bg-rose-100 dark:bg-rose-500/20 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-black mb-1">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order?</h3>
            <p class="text-slate-500 dark:text-slate-400 text-[11px] mb-6 font-medium leading-relaxed px-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Order ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö <br><span class="text-accent font-bold">‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á (Bills/Logs) ‡πÑ‡∏ß‡πâ</span></p>
            <div class="flex flex-col gap-2">
                <button onclick="clearOrdersOnly()" class="w-full bg-rose-500 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-rose-600 active:scale-95 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Order</button>
                <button onclick="closeModal('confirm-modal')" class="w-full py-2 text-slate-400 font-bold text-[10px] uppercase tracking-widest text-center">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] hidden animate-in slide-in-from-top-4 duration-300">
        <div class="px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 text-sm font-bold border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700">
            <div id="toast-icon" class="text-primary"><i data-lucide="info" class="w-4 h-4"></i></div>
            <span id="toast-msg"></span>
        </div>
    </div>

    <!-- Side Navigation (Desktop) -->
    <aside class="hidden md:flex fixed left-0 top-0 bottom-0 w-[280px] bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex-col p-6 z-50">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="bg-primary p-2 rounded-xl text-white"><i data-lucide="warehouse" class="w-5 h-5"></i></div>
            <h1 class="font-black text-lg tracking-tighter uppercase">Warehouse <span class="text-primary">TGT3</span></h1>
        </div>
        <nav class="flex-1 space-y-1 text-sm font-bold">
            <button onclick="showTab('dashboard')" id="d-nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-left"><i data-lucide="layout-dashboard" class="w-4 h-4"></i><span>Dashboard</span></button>
            <button onclick="showTab('dispatch')" id="d-nav-dispatch" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-left"><i data-lucide="scan-barcode" class="w-4 h-4"></i><span>Dispatch Center</span></button>
            <button onclick="showTab('stock')" id="d-nav-stock" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-left"><i data-lucide="package" class="w-4 h-4"></i><span>Inventory</span></button>
            <button onclick="showTab('history')" id="d-nav-history" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-left"><i data-lucide="history" class="w-4 h-4"></i><span>Logs</span></button>
            <button onclick="showTab('report')" id="d-nav-report" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-left"><i data-lucide="file-text" class="w-4 h-4"></i><span>Report</span></button>
        </nav>
        <div class="pt-6 border-t dark:border-slate-800 space-y-4">
            <div class="px-4 py-3 bg-slate-50 dark:bg-slate-800 rounded-xl text-center">
                <p class="text-[9px] font-black uppercase text-slate-400 mb-1">System Time</p>
                <p id="sidebar-clock" class="text-lg font-black tracking-tighter">00:00:00</p>
            </div>
            <button onclick="toggleTheme()" class="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Theme</span>
                <i data-lucide="sun" class="w-4 h-4 hidden dark:block text-yellow-400"></i><i data-lucide="moon" class="w-4 h-4 block dark:hidden text-slate-400"></i>
            </button>
        </div>
    </aside>

    <main class="main-content min-h-screen p-4 md:p-8 pb-32 md:pb-8">
        <!-- DASHBOARD TAB -->
        <section id="tab-dashboard" class="space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-3xl font-black tracking-tight uppercase">System <span class="text-primary">Overview</span></h2>
                    <div class="flex items-center gap-3 mt-1">
                         <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest" id="current-date-display"></p>
                         <div class="h-1 w-1 rounded-full bg-slate-300"></div>
                         <p class="text-primary text-[10px] font-black uppercase tracking-widest" id="dashboard-clock">00:00:00</p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 px-1 sm:grid-cols-2 lg:grid-cols-5">
                <div class="glass-card p-3 sm:p-6 rounded-2xl sm:rounded-3xl border border-white-100 dark:border-white-800 flex flex-col justify-between h-32 sm:h-36 text-white glow-white bg-gradient-to-br from-slate-800 to-slate-900">
                    <p class="text-[14px] sm:text-[25px] font-black uppercase tracking-widest text-white-400">Daily Target</p>
                    <h3 id="stat-daily-target" class="text-2xl sm:text-4xl font-black text-white">500</h3>
                </div>
                <div class="glass-card p-3 sm:p-6 rounded-2xl sm:rounded-3xl border border-green-100 dark:border-green-800 flex flex-col justify-between h-32 sm:h-36 text-accent glow-green">
                    <p class="text-[14px] sm:text-[25px] font-black uppercase tracking-widest text-green-400">Shipped</p>
                    <h3 id="stat-today-shipped" class="text-2xl sm:text-4xl font-black">0</h3>
                </div> 
                <div class="glass-card p-3 sm:p-6 rounded-2xl sm:rounded-3xl border border-yellow-100 dark:border-yellow-800 flex flex-col justify-between h-32 sm:h-36 text-yellow-500 glow-yellow">
                    <p class="text-[14px] sm:text-[25px] font-black uppercase tracking-widest text-yellow-400">Onplan</p>
                    <h3 id="stat-today-remaining" class="text-2xl sm:text-4xl font-black">0</h3>
                </div>
                <div class="glass-card p-3 sm:p-6 rounded-2xl sm:rounded-3xl border border-rose-100 dark:border-rose-800 flex flex-col justify-between h-32 sm:h-36 text-rose-500 glow-rose">
                    <p class="text-[14px] sm:text-[25px] font-black uppercase tracking-widest text-rose-400">Delay</p>
                    <h3 id="stat-overdue" class="text-2xl sm:text-4xl font-black">0</h3>
                </div>
                <div class="glass-card p-3 sm:p-6 rounded-2xl sm:rounded-3xl border border-blue-100 dark:border-blue-800 flex flex-col justify-between h-32 sm:h-36 text-blue-500 glow-blue">
                    <p class="text-[14px] sm:text-[25px] font-black uppercase tracking-widest text-blue-400">System Load</p>
                    <h3 id="stat-total-load" class="text-2xl sm:text-4xl font-black">0</h3>
                </div>
            </div>

            <!-- HISTORY CHARTS SECTION -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 mt-8">
                <div class="glass-card p-6 rounded-[2.5rem] border border-blue-100 dark:border-blue-800 shadow-sm">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="bar-chart" class="w-4 h-4 text-accent"></i>
                        <h4 class="text-[20px] font-black uppercase text-slate-400 tracking-widest">Monthly Order</h4>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-monthly"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border border-blue-100 dark:border-blue-800 shadow-sm">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="line-chart" class="w-4 h-4 text-accent"></i>
                        <h4 class="text-[20px] font-black uppercase text-slate-400 tracking-widest">DailyOrder</h4>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-daily-trend"></canvas>
                    </div>
                </div>
            </div>

            <!-- DELAY CHARTS SECTION -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 mt-8">
                <div class="glass-card p-6 rounded-[2.5rem] border border-rose-100 dark:border-rose-800 shadow-sm">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="bar-chart" class="w-4 h-4 text-rose-500"></i>
                        <h4 class="text-[20px] font-black uppercase text-rose-400 tracking-widest">Monthly Delay</h4>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-delay-monthly"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border border-rose-100 dark:border-rose-800 shadow-sm">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="activity" class="w-4 h-4 text-rose-500"></i>
                        <h4 class="text-[20px] font-black uppercase text-rose-400 tracking-widest">Order Delay</h4>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart-delay-daily"></canvas>
                    </div>
                </div>
            </div>

            <div class="mt-8 space-y-3">
                <div class="flex items-center gap-2 px-1"><i data-lucide="list" class="w-4 h-4 text-primary"></i><h3 class="text-sm font-black uppercase tracking-widest">Orders Summary</h3></div>
                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl overflow-hidden shadow-sm">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs min-w-[900px]">
                            <thead class="bg-slate-50 dark:bg-slate-800/50 font-black text-slate-400 uppercase tracking-tighter">
                                <tr>
                                    <th class="px-6 py-4 text-center">No.</th>
                                    <th class="px-6 py-4">Customer</th>
                                    <th class="px-6 py-4">Kanban ID</th>
                                    <th class="px-6 py-4 text-center">Order No</th>
                                    <th class="px-6 py-4">Sale Part</th>
                                    <th class="px-6 py-4 text-center">Due Date</th>
                                    <th class="px-6 py-4 text-center">Shipped Qty</th>
                                    <th class="px-6 py-4 text-center">Remaining Qty</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="divide-y divide-slate-50 dark:divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- DISPATCH CENTER TAB -->
        <section id="tab-dispatch" class="hidden space-y-6 animate-in fade-in duration-500">
            <div class="flex flex-col gap-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-black uppercase">Dispatch <span class="text-primary">Center</span></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="live-dot h-1.5 w-1.5 rounded-full bg-accent"></span>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest" id="dispatch-live-info">Scanner Ready ‚Ä¢ <span id="dispatch-clock">00:00:00</span></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <label class="cursor-pointer bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:opacity-80 transition-all">
                            <i data-lucide="upload-cloud" class="w-3.5 h-3.5"></i><span>Import Excel</span>
                            <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls">
                        </label>
                        <button onclick="openConfirmModal()" class="px-4 py-2 bg-rose-50 dark:bg-rose-500/10 text-rose-500 font-bold border border-rose-100 dark:border-rose-900/30 rounded-xl text-[10px] uppercase tracking-widest hover:bg-rose-500 hover:text-white transition-colors">Reset Orders</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <div class="relative group scan-focus-ring bg-white dark:bg-slate-900 rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-primary flex items-center gap-2">
                            <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                            <div class="h-4 w-[1px] bg-slate-200 dark:bg-slate-700 ml-1"></div>
                        </div>
                        <input type="text" id="barcode-input" autocomplete="off" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå KANBAN / PART NO / ORDER NO..." 
                               class="w-full pl-16 pr-12 py-5 bg-transparent text-lg font-black outline-none placeholder:text-slate-300 placeholder:text-sm uppercase tracking-tight">
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between px-2">
                    <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">Order Queue</span>
                    <button onclick="clearSelection()" id="clear-selection-btn-list" class="hidden text-[9px] font-black text-rose-500 uppercase tracking-widest flex items-center gap-1 hover:underline">
                        <i data-lucide="x" class="w-3 h-3"></i><span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </button>
                </div>
                <div id="dispatch-list-container" class="space-y-3 min-h-[300px] content-start"></div>
            </div>
        </section>

        <!-- INVENTORY TAB -->
        <section id="tab-stock" class="hidden space-y-6 animate-in fade-in duration-500">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                <h2 class="text-3xl font-black uppercase">Inventory <span class="text-primary">Status</span></h2>
                <div class="relative w-full md:w-80"><i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="stock-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å (Part / Kanban)..." class="w-full pl-11 pr-4 py-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-xs outline-none font-bold"></div>
            </div>
            <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl overflow-hidden shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs min-w-[800px]">
                        <thead id="stock-table-head" class="bg-slate-50 dark:bg-slate-800/50 font-black text-slate-400 uppercase">
                            <tr>
                                <th class="px-6 py-4">Customer</th>
                                <th class="px-6 py-4">Kanban ID</th>
                                <th class="px-6 py-4">Product Details</th>
                                <th class="px-6 py-4 text-center">Due Date</th>
                                <th class="px-6 py-4 text-center">Shipped Qty</th>
                                <th class="px-6 py-4 text-right">Remaining Qty</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body" class="divide-y divide-slate-50 dark:divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- REPORT TAB -->
        <section id="tab-report" class="hidden space-y-6 animate-in fade-in duration-500">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-3xl font-black tracking-tight uppercase">Report <span class="text-primary">Center</span></h2>
                    <p class="text-slate-400 text-sm mt-1">Generate and view comprehensive reports</p>
                </div>
            </div>
            
            <div class="glass-card p-6 rounded-3xl border border-slate-100 dark:border-slate-800">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-rose-100 dark:from-blue-500/20 dark:to-rose-500/20 text-transparent bg-clip-text rounded-full flex items-center justify-center">
                            <i data-lucide="file-text" class="w-6 h-6 bg-gradient-to-br from-blue-500 to-rose-500 text-transparent bg-clip-text"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-black">Report Generator</h3>
                            <p class="text-slate-400 text-sm">Dispatch & Delay reports</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Report Buttons -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-500 text-white py-4 rounded-2xl font-black uppercase text-sm hover:bg-blue-600 transition-all shadow-lg cursor-pointer flex flex-col items-center justify-center" onclick="showMonthPickerForMonthlyDispatch()">
                                <i data-lucide="truck" class="w-5 h-5 mx-auto mb-2"></i>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                            </div>
                            <button onclick="openDelayReportModal('month')" class="bg-rose-500 text-white py-4 rounded-2xl font-black uppercase text-sm hover:bg-rose-600 transition-all shadow-lg">
                                <i data-lucide="alert-circle" class="w-5 h-5 mx-auto mb-2"></i>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Delay (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-400 text-white py-4 rounded-2xl font-black uppercase text-sm hover:bg-blue-500 transition-all shadow-lg cursor-pointer flex flex-col items-center justify-center" onclick="showDatePickerForDailyDispatch()">
                                <i data-lucide="calendar" class="w-5 h-5 mx-auto mb-2"></i>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
                            </div>
                            <button onclick="openDelayReportModal('day')" class="bg-rose-400 text-white py-4 rounded-2xl font-black uppercase text-sm hover:bg-rose-500 transition-all shadow-lg">
                                <i data-lucide="clock" class="w-5 h-5 mx-auto mb-2"></i>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Delay (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
                            </button>
                        </div>
                    </div>
                </div>
            
                    </section>

        <!-- HISTORY TAB -->
        <section id="tab-history" class="hidden space-y-6 animate-in fade-in duration-500">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                <h2 class="text-3xl font-black uppercase">Dispatch <span class="text-primary">Logs</span></h2>
                <div class="relative w-full md:w-80"><i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="history-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥..." class="w-full pl-11 pr-4 py-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-xs outline-none font-bold"></div>
            </div>
            <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </section>
    </main>

    <!-- DISPATCH REPORT MODAL -->
    <div id="dispatch-report-modal" class="fixed inset-0 z-[300] hidden bg-slate-950/60 backdrop-blur-[2px] flex items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-3xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[95vh] border border-blue-500/20 animate-in zoom-in-95 duration-200">
            <div id="dispatch-report-print-area" class="p-12 flex-1 bg-white text-slate-900 overflow-y-auto">
                <div class="flex justify-between items-start border-b-4 border-blue-500 pb-8 mb-10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-500/20 text-blue-500 rounded-full flex items-center justify-center">
                            <i data-lucide="truck" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <h1 id="dispatch-report-title" class="text-3xl font-black tracking-tighter uppercase italic leading-none text-blue-600">Dispatch Summary Report</h1>
                            <p class="text-[10px] font-bold text-blue-400 mt-2 uppercase tracking-widest" id="dispatch-report-desc"></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="dispatch-report-date" class="font-black text-[12px] uppercase"></p>
                        <p class="text-[9px] font-bold text-slate-300 mt-1 uppercase tracking-widest italic">Warehouse TGT3 Official Log</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6 mb-12">
                    <div class="bg-blue-50 p-8 rounded-[2rem] border border-blue-100 flex flex-col justify-center">
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">Total Dispatch Days</p>
                        <div class="flex items-baseline gap-2">
                            <h4 id="dispatch-total-days" class="text-5xl font-black text-blue-600">0</h4>
                            <span id="dispatch-total-days-label" class="text-blue-400 font-bold text-sm uppercase">Days</span>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-8 rounded-[2rem] border border-slate-100 flex flex-col justify-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Total Units Dispatched</p>
                        <div class="flex items-baseline gap-2">
                            <h4 id="dispatch-total-units" class="text-5xl font-black text-slate-900">0</h4>
                            <span class="text-slate-400 font-bold text-sm uppercase">Pcs</span>
                        </div>
                    </div>
                </div>
                <table class="w-full mb-12 border-collapse table-fixed">
                    <thead>
                        <tr class="border-y-2 border-blue-500 bg-blue-50/50">
                            <th class="py-5 px-4 text-left text-[11px] font-black uppercase italic w-1/4">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="py-5 px-4 text-left text-[11px] font-black uppercase italic w-1/4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="py-5 px-4 text-center text-[11px] font-black uppercase italic w-1/4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
                            <th class="py-5 px-4 text-right text-[11px] font-black uppercase italic w-1/4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="dispatch-report-table" class="divide-y divide-blue-100"></tbody>
                </table>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-800 border-t flex gap-3 no-print">
                <button onclick="window.print()" class="flex-1 bg-blue-500 text-white py-4 rounded-2xl font-black uppercase text-[11px] hover:bg-blue-600 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span>Direct Print</span>
                </button>
                <button onclick="closeModal('dispatch-report-modal')" class="px-10 py-4 bg-white dark:bg-slate-700 font-black rounded-2xl text-[11px] uppercase border border-slate-200 dark:border-slate-600">Close</button>
            </div>
        </div>
    </div>

    <!-- REPORT TYPE MODAL -->
    <div id="report-type-modal" class="fixed inset-0 z-[300] hidden bg-slate-950/60 backdrop-blur-[2px] flex items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-[340px] rounded-[2rem] p-8 shadow-2xl text-center animate-in zoom-in-95 duration-200 border border-blue-500/20">
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-500/20 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="file-text" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-black mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Report</h3>
            <div class="flex flex-col gap-3 mt-6">
                <button onclick="openDispatchReportModal('month')" class="w-full bg-blue-500 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-600 active:scale-95 transition-all">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
                <button onclick="openDelayReportModal('month')" class="w-full bg-rose-500 text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-rose-600 active:scale-95 transition-all">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î Delay</button>
            </div>
            <button onclick="closeModal('report-type-modal')" class="w-full mt-6 py-2 text-slate-400 font-bold text-[10px] uppercase tracking-widest text-center">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <!-- DELAY REPORT MODAL -->
    <div id="delay-report-modal" class="fixed inset-0 z-[250] hidden flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-900 w-full max-w-4xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[95vh] border border-white/5">
            <div id="delay-report-print-area" class="p-12 flex-1 bg-white text-slate-900 overflow-y-auto">
                <div class="flex justify-between items-start border-b-4 border-rose-500 pb-8 mb-10">
                    <div>
                        <h1 class="text-3xl font-black tracking-tighter uppercase italic leading-none text-rose-600">Delayed Delivery Report</h1>
                        <p class="text-[10px] font-bold text-rose-400 mt-2 uppercase tracking-widest">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡∏™‡∏∞‡∏™‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á)</p>
                        <div class="mt-2 flex gap-2 items-center">
                                <!-- ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
                                <label class="text-xs font-bold text-slate-400 ml-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                                <select id="delay-month-select" class="border rounded-lg px-2 py-1 text-xs font-bold" onchange="openDelayReportModal('month', parseInt(this.value))">
                                </select>
                            </div>
                    </div>
                    <div class="text-right">
                        <p id="report-date" class="font-black text-[12px] uppercase"></p>
                        <p class="text-[9px] font-bold text-slate-300 mt-1 uppercase tracking-widest italic">Warehouse TGT3 Official Log</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mb-12">
                    <div class="bg-rose-50 p-8 rounded-[2rem] border border-rose-100 flex flex-col justify-center">
                        <p class="text-[10px] font-black text-rose-400 uppercase tracking-widest mb-2">Delayed Order Items</p>
                        <div class="flex items-baseline gap-2">
                            <h4 id="report-total-items" class="text-5xl font-black text-rose-600">0</h4>
                            <span class="text-rose-400 font-bold text-sm uppercase">SKUs</span>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-8 rounded-[2rem] border border-slate-100 flex flex-col justify-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Total Units Remaining (Delay)</p>
                        <div class="flex items-baseline gap-2">
                            <h4 id="report-total-units" class="text-5xl font-black text-slate-900">0</h4>
                            <span class="text-slate-400 font-bold text-sm uppercase">Pcs</span>
                        </div>
                    </div>
                </div>

                <table class="w-full mb-12 border-collapse">
                    <thead>
                        <tr class="border-y-2 border-slate-900 bg-slate-50/50">
                            <th class="py-5 px-4 text-left text-[11px] font-black uppercase italic">Customer</th>
                            <th class="py-5 px-4 text-left text-[11px] font-black uppercase italic">Kanban / Part Number</th>
                            <th class="py-5 px-4 text-center text-[11px] font-black uppercase italic">Due Date</th>
                            <th class="py-5 px-4 text-right text-[11px] font-black uppercase italic">Delay Qty</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-800 border-t flex gap-3 no-print">
                <button onclick="downloadReportPDF()" class="flex-1 bg-rose-500 text-white py-4 rounded-2xl font-black uppercase text-[11px] hover:bg-rose-600 transition-all shadow-xl shadow-rose-500/10 flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Export PDF Report</span>
                </button>
                <button onclick="window.print()" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[11px] hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span>Direct Print</span>
                </button>
                <button onclick="closeModal('delay-report-modal')" class="px-10 py-4 bg-white dark:bg-slate-700 font-black rounded-2xl text-[11px] uppercase border border-slate-200 dark:border-slate-600">Close</button>
            </div>
        </div>
    </div>

    <!-- FLOATING SHIPMENT BAR -->
    <div id="shipment-bar" class="fixed bottom-24 md:bottom-8 left-1/2 -translate-x-1/2 z-[50] hidden w-full max-w-lg px-4 animate-in slide-in-from-bottom-8">
        <div class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-full px-4 py-4 shadow-2xl flex items-center justify-between border border-white/10">
            <div class="flex items-center gap-3 ml-4">
                <div class="bg-primary text-white p-2 rounded-full"><i data-lucide="shopping-cart" class="w-4 h-4"></i></div>
                <div class="flex flex-col">
                    <span class="text-[10px] font-black uppercase opacity-60">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                    <span id="selected-count-label" class="text-xs font-black">0 Items Selected</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="clearSelection()" class="px-4 py-2 text-[10px] font-black uppercase text-rose-500 hover:bg-rose-500/10 rounded-full transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="openMultiDispatchModal()" class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-full text-xs font-black uppercase tracking-widest transition-all shadow-lg active:scale-95">Confirm</button>
            </div>
        </div>
    </div>

    <!-- MULTI DISPATCH MODAL -->
    <div id="multi-dispatch-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-900 w-full max-w-xl rounded-[2.5rem] p-8 shadow-2xl space-y-6 animate-in zoom-in-95 duration-200 border border-white/10 flex flex-col max-h-[90vh]">
            <div class="text-center">
                <h3 class="text-2xl font-black uppercase tracking-tight">Confirm <span class="text-primary">Dispatch</span></h3>
                <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</p>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 px-1" id="multi-dispatch-list"></div>
            <div class="space-y-4 pt-4 border-t dark:border-slate-800">
                <div class="relative">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-2 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô ‡∏ñ‡∏∂‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</label>
                    <div class="relative">
                        <input type="date" id="dispatch-date-input" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800 px-4 py-4 rounded-2xl appearance-none font-black text-xs outline-none focus:ring-2 focus:ring-primary/20 transition-all" />
                        <i data-lucide="calendar" class="w-4 h-4 absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="multi-btn-round-am" onclick="setSelectedRound('‡πÄ‡∏ä‡πâ‡∏≤')" class="py-3 rounded-2xl text-[10px] font-black uppercase border border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="sun" class="w-3 h-3"></i><span>‡πÄ‡∏ä‡πâ‡∏≤ (AM)</span>
                    </button>
                    <button id="multi-btn-round-pm" onclick="setSelectedRound('‡∏ö‡πà‡∏≤‡∏¢')" class="py-3 rounded-2xl text-[10px] font-black uppercase border border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="moon" class="w-3 h-3"></i><span>‡∏ö‡πà‡∏≤‡∏¢ (PM)</span>
                    </button>
                </div>
                <div class="relative">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-2 mb-1 block">Ship-to Destination (‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á)</label>
                    <div class="relative">
                        <select id="multi-select-destination" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800 px-4 py-4 rounded-2xl appearance-none font-black text-xs outline-none focus:ring-2 focus:ring-primary/20 transition-all">
                            <option value="TMRD">TMRD (Thai Meira RD)</option>
                            <option value="TGT1">TGT1 (Thai Goshi Plant 1)</option>
                            <option value="TGT2">TGT2 (Thai Goshi Plant 2)</option>
                            <option value="TGT3" selected>TGT3 (Thai Goshi Plant 3)</option>
                        </select>
                        <i data-lucide="chevron-down" class="w-4 h-4 absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <button onclick="executeMultiDispatch()" class="w-full btn-primary py-5 rounded-2xl font-black uppercase text-sm shadow-xl hover:scale-[1.01] transition-all">Generate Delivery Bill</button>
                <button onclick="closeModal('multi-dispatch-modal')" class="w-full text-slate-400 font-bold text-[10px] uppercase tracking-widest text-center">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- INVOICE MODAL -->
    <div id="invoice-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div id="invoice-print-area" class="p-10 flex-1 bg-white text-slate-900 overflow-y-auto">
                <div class="flex justify-between items-start border-b-2 border-slate-900 pb-6 mb-8">
                    <div>
                        <h1 class="text-2xl font-black tracking-tighter italic leading-none">DELIVERY BILL</h1>
                        <p class="text-[9px] font-bold text-slate-400 mt-1 uppercase">Warehouse System TGT3</p>
                    </div>
                    <div class="text-right">
                        <p id="inv-date" class="font-black text-[11px]"></p>
                        <p id="inv-round" class="font-black text-[11px] uppercase text-primary"></p>
                        <p id="inv-id" class="text-[9px] font-bold text-slate-300"></p>
                    </div>
                </div>
                <div class="flex justify-between mb-8">
                    <div>
                        <p class="text-[9px] font-black uppercase text-slate-400 mb-0.5">Ship-to Destination</p>
                        <h2 id="inv-destination" class="text-xl font-black uppercase leading-tight text-primary"></h2>
                        <div class="mt-2">
                             <p class="text-[9px] font-black uppercase text-slate-400 mb-0.5">Original Customer</p>
                             <p id="inv-customer" class="text-sm font-bold uppercase"></p>
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="qrcode" class="p-1 border-2 border-slate-100 rounded-lg"></div>
                        <p class="text-[7px] font-black uppercase text-slate-300 mt-1">Verify Authenticity</p>
                    </div>
                </div>
                <table class="w-full mb-12 border-collapse">
                    <thead>
                        <tr class="border-y border-slate-900">
                            <th class="py-3 text-left text-[10px] font-black uppercase italic">Kanban / Part No.</th>
                            <th class="py-3 text-left text-[10px] font-black uppercase italic">Order Ref.</th>
                            <th class="py-3 text-right text-[10px] font-black uppercase italic">Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="inv-items-body" class="divide-y divide-slate-100"></tbody>
                    <tfoot>
                        <tr class="border-t border-slate-900">
                            <td colspan="2" class="py-4 text-right font-black text-[11px] uppercase italic">Total Items</td>
                            <td id="inv-total-qty" class="py-4 text-right text-2xl font-black"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="p-5 bg-slate-50 dark:bg-slate-800 border-t flex gap-2 no-print">
                <button onclick="downloadInvoicePDF()" class="flex-1 bg-accent text-white py-4 rounded-2xl font-black uppercase text-[11px]">Export PDF</button>
                <button onclick="window.print()" class="flex-1 btn-primary py-4 rounded-2xl font-black uppercase text-[11px]">Print Bill</button>
                <button onclick="closeModal('invoice-modal')" class="px-8 py-4 bg-white dark:bg-slate-700 font-black rounded-2xl text-[11px] uppercase">Close</button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 md:hidden bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 z-40">
        <div class="flex justify-around items-center h-20">
            <button onclick="showTab('dashboard')" id="m-nav-dashboard" class="flex-1 flex flex-col items-center justify-center gap-1 py-3 text-slate-500 nav-btn">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Dash</span>
            </button>
            <button onclick="showTab('dispatch')" id="m-nav-dispatch" class="flex-1 flex flex-col items-center justify-center gap-1 py-3 text-slate-500 nav-btn">
                <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Ship</span>
            </button>
            <button onclick="showTab('stock')" id="m-nav-stock" class="flex-1 flex flex-col items-center justify-center gap-1 py-3 text-slate-500 nav-btn">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Stock</span>
            </button>
            <button onclick="showTab('history')" id="m-nav-history" class="flex-1 flex flex-col items-center justify-center gap-1 py-3 text-slate-500 nav-btn">
                <i data-lucide="history" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Logs</span>
            </button>
            <button onclick="showTab('report')" id="m-nav-report" class="flex-1 flex flex-col items-center justify-center gap-1 py-3 text-slate-500 nav-btn">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="text-[10px] font-black uppercase tracking-tighter">Report</span>
            </button>
        </div>
    </nav>

    <!-- Scroll to Top Button -->
    <button onclick="scrollToTop()" id="scroll-to-top" class="fixed bottom-24 right-8 z-[9999] bg-primary hover:bg-blue-600 text-white p-4 rounded-full shadow-2xl transition-all duration-300 opacity-0 invisible scale-0 active:scale-95">
        <i data-lucide="arrow-up" class="w-5 h-5"></i>
    </button>

    <script>
        // Database Initialization
        const db = new Dexie('TGT3_Warehouse_MultiDispatch_V3');
        db.version(1).stores({
            orders: '++id, [customer+salePart+deliveryDate+orderNo+kanbanId], customer, salePart, kanbanId, deliveryDate, qty, round, orderNo',
            history: '++id, timestamp, customer, round, itemsJson, destination'
        });

        const getTodayStr = () => new Date().toISOString().split('T')[0];
        const todayStr = getTodayStr();
        let selectedRoundInModal = '‡πÄ‡∏ä‡πâ‡∏≤';
        let selectedOrderIds = new Set();
        let myCharts = {};

        // Utilities
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            ['sidebar-clock', 'dashboard-clock', 'dispatch-clock'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerText = timeStr;
            });
        }
        setInterval(updateClock, 1000);

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        }

        function toggleLoading(s, msg = "Processing...") { 
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-progress').innerText = msg;
            overlay.classList.toggle('hidden', !s); 
        }
        
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function toggleTheme() { 
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Update charts colors if they exist
            if (myCharts.monthly) {
                myCharts.monthly.options.scales.x.grid.color = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
                myCharts.monthly.options.scales.y.grid.color = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
                myCharts.monthly.update();
            }
        }

        function setSelectedRound(r) {
            selectedRoundInModal = (r === '‡πÄ‡∏ä‡πâ‡∏≤' || r === 'AM') ? '‡πÄ‡∏ä‡πâ‡∏≤' : '‡∏ö‡πà‡∏≤‡∏¢';
            const btnAM = document.getElementById('multi-btn-round-am');
            const btnPM = document.getElementById('multi-btn-round-pm');
            if(selectedRoundInModal === '‡πÄ‡∏ä‡πâ‡∏≤') { 
                btnAM.classList.add('round-btn-active'); btnPM.classList.remove('round-btn-active'); 
            } else { 
                btnPM.classList.add('round-btn-active'); btnAM.classList.remove('round-btn-active'); 
            }
        }

        // --- Charts Initialization ---
        function initDashboardCharts() {
            // Register DataLabels plugin
            Chart.register(ChartDataLabels);
            
            const ctxMonthly = document.getElementById('chart-monthly').getContext('2d');
            const ctxDaily = document.getElementById('chart-daily-trend').getContext('2d');
            const ctxDelayMonthly = document.getElementById('chart-delay-monthly').getContext('2d');
            const ctxDelayDaily = document.getElementById('chart-delay-daily').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');

            // Dispatch Monthly History: Line (Total Orders) + Bar (Actual Orders)
            myCharts.monthly = new Chart(ctxMonthly, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            type: 'line',
                            label: 'Total Orders',
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                offset: -5,
                                color: '#3b82f6',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value) => value > 0 ? value : ''
                            },
                            data: []
                        },
                        {
                            type: 'bar',
                            label: 'Actual Orders',
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            borderRadius: 8,
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#10b981',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value) => value > 0 ? value : ''
                            },
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 14, weight: 'bold' } } },
                        y: { grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 14 } } }
                    }
                }
            });

            // 7-Day Dispatch Trend: Line (Total Orders) + Bar (Actual Orders)
            myCharts.daily = new Chart(ctxDaily, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            type: 'line',
                            label: 'Total Orders',
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                offset: -5,
                                color: '#3b82f6',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value) => value > 0 ? value : ''
                            },
                            data: []
                        },
                        {
                            type: 'bar',
                            label: 'Actual Orders',
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            borderRadius: 8,
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#10b981',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value) => value > 0 ? value : ''
                            },
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 14, weight: 'bold' } } },
                        y: { grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 14 } } }
                    }
                }
            });

            myCharts.delayMonthly = new Chart(ctxDelayMonthly, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Delay ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', backgroundColor: '#ef4444', borderRadius: 8, data: [] }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#ef4444',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 14, weight: 'bold' } } },
                        y: { grid: { color: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(239,68,68,0.08)' }, ticks: { font: { size: 14 } } }
                    }
                }
            });

            myCharts.delayDaily = new Chart(ctxDelayDaily, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á', backgroundColor: '#ef4444', borderColor: '#ef4444', borderWidth: 2, data: [] }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, position: 'top', labels: { 
                            font: { size: 14, weight: 'bold' },
                            padding: 25
                        } },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#ef4444',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value) => value > 0 ? value : ''
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const order = window.delayedOrdersData[index];
                                    if (order) {
                                        return [
                                            `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${order.customer}`,
                                            `Part: ${order.salePart}`,
                                            `Kanban: ${order.kanbanId || '-'}`,
                                            `Order No: ${order.orderNo}`,
                                            `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${order.deliveryDate}`
                                        ];
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 14, weight: 'bold' }, maxRotation: 45, minRotation: 45 } },
                        y: { grid: { color: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(239,68,68,0.08)' }, ticks: { font: { size: 14 } }, beginAtZero: true }
                    }
                }
            });
        }

        async function updateChartsData() {
            const logs = await db.history.toArray();
            const orders = await db.orders.toArray();
            // 1. Monthly History (Full Year)‡∏Ü
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            // Total Orders (‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á) ‡πÉ‡∏ä‡πâ originQty
            const monthlyTotalOrders = new Array(12).fill(0);
            orders.forEach(order => {
                if (order.originQty > 0) {
                    const date = new Date(order.deliveryDate);
                    monthlyTotalOrders[date.getMonth()] += order.originQty;
                }
            });
            // Actual Orders (‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á)
            const monthlyActualOrders = new Array(12).fill(0);
            logs.forEach(log => {
                const date = new Date(log.timestamp);
                const items = JSON.parse(log.itemsJson);
                const qty = items.reduce((s, i) => s + i.qty, 0);
                monthlyActualOrders[date.getMonth()] += qty;
            });
            myCharts.monthly.data.labels = months;
            myCharts.monthly.data.datasets[0].data = monthlyTotalOrders;
            myCharts.monthly.data.datasets[1].data = monthlyActualOrders;
            myCharts.monthly.update();

            // 1.1 Delay Monthly (Full Year) - History ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î Delay (order ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞ deliveryDate < ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
            const delayMonthlyStats = new Array(12).fill(0);
            orders.forEach(order => {
                if (order.qty > 0 && order.deliveryDate < todayStr) {
                    const date = new Date(order.deliveryDate);
                    delayMonthlyStats[date.getMonth()] += order.qty;
                }
            });
            myCharts.delayMonthly.data.labels = months;
            myCharts.delayMonthly.data.datasets[0].data = delayMonthlyStats;
            myCharts.delayMonthly.update();

            // 2. Daily Trend (Last 7 Days)‡∏´
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }
            // Total Orders (‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á) ‡πÉ‡∏ä‡πâ originQty
            const dailyTotalOrders = last7Days.map(dateStr => {
                return orders.filter(o => o.originQty > 0 && o.deliveryDate === dateStr).reduce((sum, o) => sum + o.originQty, 0);
            });
            // Actual Orders (‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á) - ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö
            const dailyActualOrders = last7Days.map(dateStr => {
                const dayLogs = logs.filter(l => l.timestamp.startsWith(dateStr));
                const totalQty = dayLogs.reduce((acc, log) => {
                    const items = JSON.parse(log.itemsJson);
                    return acc + items.reduce((s, i) => s + i.qty, 0);
                }, 0);
                const roundCount = dayLogs.length; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á
                return { qty: totalQty, rounds: roundCount };
            });
            myCharts.daily.data.labels = last7Days.map(d => d.split('-').slice(1).reverse().join('/'));
            myCharts.daily.data.datasets[0].data = dailyTotalOrders;
            myCharts.daily.data.datasets[1].data = dailyActualOrders.map(d => d.qty);
            myCharts.daily.update();

            // 2.1 Delay Daily - History ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
            const delayedOrders = orders.filter(o => o.qty > 0 && o.deliveryDate < todayStr)
                                     .sort((a, b) => b.qty - a.qty) // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                                     .slice(0, 10); // ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tooltip
            window.delayedOrdersData = delayedOrders;
            
            const orderLabels = delayedOrders.map((o, index) => 
                `${index + 1}. ${o.kanbanId || o.orderNo || 'N/A'}` // ‡πÅ‡∏™‡∏î‡∏á KanbanID ‡∏´‡∏£‡∏∑‡∏≠ OrderNo ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ KanbanID
            );
            const orderQuantities = delayedOrders.map(o => o.qty);
            
            myCharts.delayDaily.data.labels = orderLabels;
            myCharts.delayDaily.data.datasets[0].data = orderQuantities;
            myCharts.delayDaily.update();
        }

        async function updateDashboard() {
            const all = await db.orders.toArray();
            const logs = await db.history.toArray();
            
            let shippedTodayQty = 0;
            let shippedTodayRounds = 0;
            const todayLogs = logs.filter(l => {
                const logDate = new Date(l.timestamp).toISOString().split('T')[0];
                return logDate === todayStr;
            });
            console.log('Today logs:', todayLogs.length, todayLogs);
            todayLogs.forEach(l => {
                const items = JSON.parse(l.itemsJson);
                items.forEach(i => shippedTodayQty += i.qty);
                shippedTodayRounds++; // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á
            });

            const delayItems = all.filter(o => o.qty > 0 && o.deliveryDate < todayStr);
            const delayCount = delayItems.length;

            document.getElementById('stat-today-shipped').innerText = shippedTodayQty;
            document.getElementById('stat-overdue').innerText = delayCount;
            document.getElementById('stat-today-remaining').innerText = Math.max(0, 500 - shippedTodayQty);
            document.getElementById('stat-total-load').innerText = all.reduce((sum, o) => sum + o.qty, 0);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ô console
            console.log(`‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ ${shippedTodayRounds} ‡∏£‡∏≠‡∏ö, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${shippedTodayQty} ‡∏ä‡∏¥‡πâ‡∏ô`);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const todayShippedItems = [];
            todayLogs.forEach(log => {
                const items = JSON.parse(log.itemsJson);
                items.forEach(item => {
                    todayShippedItems.push({
                        customer: log.customer,
                        round: log.round,
                        destination: log.destination,
                        ...item
                    });
                });
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (todayShippedItems.length > 0) {
                console.log('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:', todayShippedItems);
            }

            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = all.sort((a,b) => a.deliveryDate.localeCompare(b.deliveryDate)).map((o, index) => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <td class="px-6 py-3 text-center font-black text-primary uppercase">${index + 1}</td>
                    <td class="px-6 py-3 font-black text-primary uppercase">${o.customer}</td>
                    <td class="px-6 py-3 font-bold text-slate-600 dark:text-slate-300">${o.kanbanId || '-'}</td>
                    <td class="px-6 py-3 font-bold text-slate-400 text-center">${o.orderNo}</td>
                    <td class="px-6 py-3 font-medium">${o.salePart}</td>
                    <td class="px-6 py-3 text-center">
                        <div class="text-[10px] font-bold ${o.deliveryDate < todayStr ? 'text-rose-500' : 'text-slate-500'}">${o.deliveryDate}</div>
                    </td>
                    <td class="px-6 py-3 text-center font-bold text-accent">${o.shippedQty || 0}</td>
                    <td class="px-6 py-3 text-center font-black ${o.qty > 0 ? 'text-rose-500' : 'text-slate-200'}">${o.qty}</td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateChartsData();
        }

        // Selection & Multi-Dispatch
        function toggleOrderSelection(id) {
            if (selectedOrderIds.has(id)) selectedOrderIds.delete(id);
            else selectedOrderIds.add(id);
            updateShipmentBar(); updateDispatchList(); 
        } 

        function clearSelection() {
            selectedOrderIds.clear(); updateShipmentBar(); updateDispatchList();
            showToast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
        }

        function updateShipmentBar() {
            const bar = document.getElementById('shipment-bar');
            const clearBtnList = document.getElementById('clear-selection-btn-list');
            if (selectedOrderIds.size > 0) {
                bar.classList.remove('hidden');
                if(clearBtnList) clearBtnList.classList.remove('hidden');
                document.getElementById('selected-count-label').innerText = `${selectedOrderIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ`;
            } else {
                bar.classList.add('hidden');
                if(clearBtnList) clearBtnList.classList.add('hidden');
            }
        }

        async function openMultiDispatchModal() {
            const items = await Promise.all(Array.from(selectedOrderIds).map(id => db.orders.get(id)));
            document.getElementById('multi-dispatch-list').innerHTML = items.map(o => `
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-3xl border border-slate-100 dark:border-slate-800/50">
                    <div class="flex justify-between items-start mb-3">
                        <div class="min-w-0 flex-1 pr-2">
                            <p class="text-[9px] font-black text-primary uppercase">${o.customer}</p>
                            <h4 class="font-black text-xs truncate uppercase dark:text-white">${o.kanbanId || '-'}</h4>
                            <p class="text-[8px] font-black text-accent uppercase">PART: ${o.salePart}</p>
                        </div>
                        <div class="text-right"><p class="text-[8px] font-black text-slate-400 uppercase">Stock</p><p class="font-black text-sm dark:text-white">${o.qty}</p></div>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-400 uppercase">‡∏™‡πà‡∏á:</span>
                        <input type="number" id="qty-input-${o.id}" value="${o.qty}" max="${o.qty}" min="1" class="w-full bg-white dark:bg-slate-900 border-2 border-transparent focus:border-primary pl-12 pr-4 py-3 rounded-2xl outline-none font-black text-lg dark:text-white">
                    </div>
                </div>
            `).join('');
            setSelectedRound('‡πÄ‡∏ä‡πâ‡∏≤');
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô ‡∏ñ‡∏∂‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)
            const dateInput = document.getElementById('dispatch-date-input');
            const today = new Date();
            const minDate = new Date(today);
            const maxDate = new Date(today);
            minDate.setDate(today.getDate() - 7);  // ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô
            maxDate.setDate(today.getDate() + 7);  // ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ 7 ‡∏ß‡∏±‡∏ô
            
            dateInput.min = minDate.toISOString().split('T')[0];
            dateInput.max = maxDate.toISOString().split('T')[0];
            dateInput.value = today.toISOString().split('T')[0];
            
            document.getElementById('multi-dispatch-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        async function executeMultiDispatch() {
            const itemsToShip = [];
            let totalQty = 0;
            let primaryCustomer = "";
            const destination = document.getElementById('multi-select-destination').value;

            for(const id of Array.from(selectedOrderIds)) {
                const o = await db.orders.get(id);
                const inputVal = parseInt(document.getElementById(`qty-input-${id}`).value);
                if(!inputVal || inputVal <= 0 || inputVal > o.qty) { showToast(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${o.salePart}`); return; }

                itemsToShip.push({ orderId: id, salePart: o.salePart, orderNo: o.orderNo, kanbanId: o.kanbanId || '-', qty: inputVal });
                totalQty += inputVal; primaryCustomer = o.customer;
                await db.orders.update(id, { qty: o.qty - inputVal, shippedQty: (o.shippedQty || 0) + inputVal });
            }

            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const dispatchDate = document.getElementById('dispatch-date-input').value;
            const dispatchDateTime = new Date(dispatchDate + 'T' + new Date().toTimeString().slice(0, 8)).toISOString();

            const historyId = await db.history.add({ customer: primaryCustomer, timestamp: dispatchDateTime, round: selectedRoundInModal, itemsJson: JSON.stringify(itemsToShip), destination: destination });
            closeModal('multi-dispatch-modal'); selectedOrderIds.clear(); updateShipmentBar(); updateDispatchList();
            showToast(`‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${totalQty} ‡∏ä‡∏¥‡πâ‡∏ô`); viewInvoice(historyId); updateDashboard();
        }

        // Refund Logic
        function confirmRefund(logId) {
            const modal = document.getElementById('refund-confirm-modal');
            const confirmBtn = document.getElementById('confirm-refund-btn');
            modal.classList.remove('hidden');
            confirmBtn.onclick = () => executeRefund(logId);
        }

        async function executeRefund(logId) {
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...");
            try {
                const log = await db.history.get(logId);
                if (!log) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ô‡∏µ‡πâ");

                const items = JSON.parse(log.itemsJson);
                for (const item of items) {
                    const order = await db.orders.get(item.orderId);
                    if (order) {
                        await db.orders.update(item.orderId, {
                            qty: order.qty + item.qty,
                            shippedQty: Math.max(0, (order.shippedQty || 0) - item.qty)
                        });
                    }
                }
                await db.history.delete(logId);
                showToast("‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Refunded)");
                closeModal('refund-confirm-modal');
                renderHistory(); updateDashboard();
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // Data Management
        async function updateDispatchList() {
            const search = document.getElementById('barcode-input').value.toUpperCase();
            let list = await db.orders.where('qty').above(0).toArray();
            if(search) list = list.filter(o => o.customer.toUpperCase().includes(search) || o.salePart.toUpperCase().includes(search) || o.orderNo.toUpperCase().includes(search) || (o.kanbanId && o.kanbanId.toUpperCase().includes(search)));
            
            const container = document.getElementById('dispatch-list-container');
            container.innerHTML = list.length === 0 ? `<div class="py-20 text-center opacity-20 text-xs font-bold uppercase italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>` : list.map(o => {
                const isSelected = selectedOrderIds.has(o.id);
                const isDelayed = o.deliveryDate < todayStr && o.qty > 0; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà Delay ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                return `
                <div onclick="toggleOrderSelection(${o.id})" class="cursor-pointer p-6 rounded-3xl border transition-all group shadow-sm active:scale-95 ${
                    isSelected 
                        ? 'border-primary ring-2 ring-primary/10' 
                        : isDelayed 
                            ? 'bg-rose-50 dark:bg-rose-900/20 border-rose-300 dark:border-rose-600' 
                            : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800'
                }">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-primary border-primary text-white' : isDelayed ? 'border-rose-400 bg-rose-100 dark:bg-rose-800/30' : 'border-slate-200 dark:border-slate-700'}">${isSelected ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</div>
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-[12px] font-black uppercase tracking-tighter ${isDelayed ? 'text-rose-600 dark:text-rose-400' : 'text-primary'}">${o.customer}</span>
                                    <span class="text-[10px] font-black px-2 py-1 rounded uppercase ${isDelayed ? 'bg-rose-200 dark:bg-rose-800/50 text-rose-700 dark:text-rose-300' : 'bg-accent/10 text-accent'}">${o.salePart || '-'}</span>
                                    ${isDelayed ? '<span class="text-[8px] font-black bg-rose-500 text-white px-2 py-1 rounded-full uppercase animate-pulse">DELAY</span>' : ''}
                                </div>
                                <div class="flex items-center gap-4">
                                    <h4 class="font-black text-lg uppercase tracking-tight ${isDelayed ? 'text-rose-700 dark:text-rose-300' : ''}">${o.kanbanId}</h4>
                                    <div class="text-[10px] font-bold ${isDelayed ? 'text-rose-600 dark:text-rose-400' : 'text-slate-400'}">${o.orderNo}</div>
                                </div>
                                <div class="flex items-center gap-6 text-sm">
                                    <span class="text-[10px] font-bold ${o.deliveryDate < todayStr ? 'text-rose-500' : 'text-slate-500'}">Due: ${o.deliveryDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black uppercase ${isDelayed ? 'text-rose-600 dark:text-rose-400' : 'text-slate-300'}">Stock</p>
                            <p class="font-black text-2xl leading-none ${isDelayed ? 'text-rose-600 dark:text-rose-400' : ''}">${o.qty}</p>
                        </div>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        // Excel Import
        document.getElementById('excel-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                    const sheetName = wb.SheetNames.find(n => n.includes("TGT3")) || wb.SheetNames[0];
                    const sheet = wb.Sheets[sheetName];
                    const raw = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    let map = { cust: -1, part: -1, kanban: -1, date: -1, qty: -1, order: -1 };
                    const head = raw.find(r => {
                        r.forEach((c, i) => {
                            const v = String(c || "").toUpperCase();
                            if(v.includes("CUSTOMER")) map.cust = i;
                            if(v.includes("CUSTOMER CODE") || v.includes("CUSTOMER ID")) map.cust = i;
                            if(v.includes("CUSTOMER NAME")) map.cust = i;
                            if(v.includes("SALE PART") || v.includes("PART NO")) map.part = i;
                            if(v.includes("KANBAN") || v.includes("TAG ID")) map.kanban = i;
                            if(v.includes("DATE")) map.date = i;
                            if(v.includes("QTY")) map.qty = i;
                            if(v.includes("ORDER NO1") || v.includes("ORDER REF")) map.order = i;
                        });
                        return map.cust !== -1 && map.part !== -1;
                    });

                    if(!head) throw new Error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Customer/Part)");

                    const rows = raw.slice(raw.indexOf(head) + 1).filter(r => r[map.cust]);
                    let newAdded = 0;
                    let duplicates = 0;

                    for (const r of rows) {
                        const customer = String(r[map.cust] || "").trim();
                        const salePart = String(r[map.part] || "").trim();
                        const kanbanId = map.kanban !== -1 ? String(r[map.kanban] || "").trim() : "";
                        const orderNo = String(r[map.order] || "-").trim();
                        const deliveryDate = r[map.date] ? (typeof r[map.date] === 'number' ? new Date((r[map.date] - 25569) * 86400 * 1000).toISOString().split('T')[0] : String(r[map.date]).split(' ')[0]) : todayStr;
                        const qtyInFile = parseInt(r[map.qty]) || 0;
                        if (qtyInFile <= 0) continue;

                        const existing = await db.orders.where({ customer, salePart, deliveryDate, orderNo, kanbanId }).first();
                        if (existing) duplicates++;
                        else {
                            await db.orders.add({ customer, salePart, kanbanId, deliveryDate, orderNo, qty: qtyInFile, originQty: qtyInFile, shippedQty: 0, round: "‡πÄ‡∏ä‡πâ‡∏≤" });
                            newAdded++;
                        }
                    }

                    if (duplicates > 0) {
                        document.getElementById('duplicate-count-text').innerHTML = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="text-amber-500 font-bold">${duplicates} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span> <br>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß`;
                        document.getElementById('duplicate-alert-modal').classList.remove('hidden');
                    }

                    showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${newAdded} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà`);
                    showTab('dashboard');
                    e.target.value = ''; 
                } catch (err) { alert(err.message); }
                finally { toggleLoading(false); }
            };
            reader.readAsArrayBuffer(file);
        };

        // Stock & History UI
        async function updateStockTable() {
            const search = document.getElementById('stock-search').value.toUpperCase();
            let all = await db.orders.toArray();
            if(search) all = all.filter(o => o.customer.toUpperCase().includes(search) || o.salePart.toUpperCase().includes(search) || (o.kanbanId && o.kanbanId.toUpperCase().includes(search)));
            document.getElementById('stock-table-body').innerHTML = all.map(o => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <td class="px-6 py-4 font-black text-primary uppercase">${o.customer}</td>
                    <td class="px-6 py-4 font-bold text-slate-500">${o.kanbanId || '-'}</td>
                    <td class="px-6 py-4"><div>${o.salePart}</div><div class="text-[9px] text-slate-400 uppercase font-bold">${o.orderNo}</div></td>
                    <td class="px-6 py-4 text-center font-bold text-slate-400">${o.deliveryDate}</td>
                    <td class="px-6 py-4 text-center font-black text-accent">${o.shippedQty || 0}</td>
                    <td class="px-6 py-4 text-right font-black text-lg">${o.qty}</td>
                </tr>
            `).join('');
        }

        async function renderHistory() {
            const search = document.getElementById('history-search').value.toUpperCase();
            let logs = await db.history.orderBy('id').reverse().toArray();
            if(search) logs = logs.filter(l => l.customer.toUpperCase().includes(search) || (l.destination && l.destination.toUpperCase().includes(search)));
            
            document.getElementById('history-container').innerHTML = logs.map(l => {
                const dt = new Date(l.timestamp);
                const items = JSON.parse(l.itemsJson);
                return `
                    <div class="p-5 bg-white dark:bg-slate-900 border rounded-[2rem] shadow-sm hover:border-primary transition-all relative group">
                        <div class="flex justify-between items-start mb-4">
                            <div><span class="text-[8px] font-black bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-500 uppercase">${dt.toLocaleDateString()}</span><p class="text-[10px] font-black text-primary mt-1">${dt.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })} ‡∏ô.</p></div>
                            <div class="flex gap-2">
                                <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded ${l.round === '‡πÄ‡∏ä‡πâ‡∏≤' ? 'round-am' : 'round-pm'}">‡∏£‡∏≠‡∏ö${l.round}</span>
                                <button onclick="viewInvoice(${l.id})" class="text-slate-300 hover:text-primary transition-colors"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                <button onclick="confirmRefund(${l.id})" class="text-slate-200 hover:text-orange-500 transition-colors" title="Refund/Return"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <p class="font-black text-primary text-sm uppercase mb-1">${l.destination || 'TGT3'}</p>
                        <p class="font-black text-xs uppercase mb-3 text-slate-400 truncate">${l.customer}</p>
                        <div class="pt-3 border-t border-slate-50 dark:border-slate-800 flex justify-between items-end"><span class="text-[8px] font-black text-slate-300 uppercase">‡∏£‡∏ß‡∏°</span><span class="text-xl font-black text-accent">${items.reduce((sum, i) => sum + i.qty, 0)}</span></div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function viewInvoice(hid) {
            const h = await db.history.get(hid);
            const dt = new Date(h.timestamp);
            const items = JSON.parse(h.itemsJson);
            document.getElementById('inv-date').innerText = dt.toLocaleDateString('th-TH', { dateStyle: 'long' });
            document.getElementById('inv-round').innerText = `‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: ${h.round}`;
            document.getElementById('inv-id').innerText = `BILL ID: TGT3-${h.id.toString().padStart(5, '0')}`;
            document.getElementById('inv-destination').innerText = h.destination || 'TGT3';
            document.getElementById('inv-customer').innerText = h.customer;
            document.getElementById('inv-total-qty').innerText = items.reduce((sum, i) => sum + i.qty, 0);
            const qr = document.getElementById("qrcode"); qr.innerHTML = ""; new QRCode(qr, { text: `TGT3-VERIFY-${h.id}`, width: 64, height: 64 });
            document.getElementById('invoice-modal').classList.remove('hidden');
        }

        // PDF & System Settings
        function downloadInvoicePDF() { html2pdf().set({ margin: 10, filename: 'TGT3_Delivery_Bill.pdf', jsPDF: { format: 'a4' } }).from(document.getElementById('invoice-print-area')).save(); }

        // Scroll to Top functionality
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Show/hide scroll to top button based on scroll position
        function handleScroll() {
            const scrollButton = document.getElementById('scroll-to-top');
            if (scrollButton) {
                if (window.pageYOffset > 300) {
                    scrollButton.classList.remove('opacity-0', 'invisible', 'scale-0');
                    scrollButton.classList.add('opacity-100', 'visible', 'scale-100');
                } else {
                    scrollButton.classList.add('opacity-0', 'invisible', 'scale-0');
                    scrollButton.classList.remove('opacity-100', 'visible', 'scale-100');
                }
            }
        }

        function showTab(tab) {
            ['dashboard', 'dispatch', 'stock', 'history', 'report'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                if(document.getElementById(`d-nav-${t}`)) document.getElementById(`d-nav-${t}`).classList.remove('sidebar-btn-active');
                if(document.getElementById(`m-nav-${t}`)) document.getElementById(`m-nav-${t}`).classList.remove('text-primary');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            if(document.getElementById(`d-nav-${tab}`)) document.getElementById(`d-nav-${tab}`).classList.add('sidebar-btn-active');
            if(document.getElementById(`m-nav-${tab}`)) document.getElementById(`m-nav-${tab}`).classList.add('text-primary');
            
            if(tab === 'dashboard') updateDashboard();
            if(tab === 'dispatch') { updateDispatchList(); setTimeout(() => document.getElementById('barcode-input').focus(), 200); }
            if(tab === 'stock') updateStockTable();
            if(tab === 'history') renderHistory();
        }
        
        lucide.createIcons();

        function openConfirmModal() { document.getElementById('confirm-modal').classList.remove('hidden'); }
        async function clearOrdersOnly() { await db.orders.clear(); closeModal('confirm-modal'); showTab('dashboard'); showToast("‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Order ‡πÅ‡∏•‡πâ‡∏ß"); }

        // Event Listeners
        document.getElementById('stock-search').oninput = updateStockTable;
        document.getElementById('history-search').oninput = renderHistory;
        document.getElementById('barcode-input').oninput = updateDispatchList;
        
        // Add scroll event listener
        window.addEventListener('scroll', handleScroll);
        
        window.onload = () => {
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('en-GB', { dateStyle: 'full' });
            initDashboardCharts();
            updateChartsData();
            updateClock(); 
            showTab('dashboard');
            
            // Initialize scroll button state
            handleScroll();
        };
    </script>
</body>
</html>